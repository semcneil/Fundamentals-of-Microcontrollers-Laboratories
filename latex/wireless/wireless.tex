\chapter{Wireless}
\chaplabel{wireless}

\section{Purpose}
The goal of this lab is to play with WiFi, Bluetooth, and time. Some of the example
sketches are in a .zip file on Canvas. Download the zip file and unzip it into the 
Arduino directory (typically Documents/Arduino). You should see directories with 
your other sketches inside the Arduino folder.

\section{Laboratory}
\subsection{Preparation}
Before you start this lab, be sure you have updated the following:
\begin{enumerate}
    \item The Arduino IDE to the latest in the 1.x series (not the 2.x IDE)
    \item WiFiNINA module firmware
    \item The main libraries used for this lab 
    \begin{enumerate}
        \item WiFiNINA
        \item ArduinoBLE
    \end{enumerate}
\end{enumerate}

\subsection{NFC}
The ST25DV library is the one in the Arduino Library Manages written by stm32duino.
Use the example to make sure that your NFC chip is updated with the latest
IP address for your module (this requires adding WiFi connection to your sketch), 
and one of your email addresses. Test this and as with each other section, 
demonstrate this to your instructor/TA.

To convert the IPAddress to a \lstinline@String@ try the following:\\
\lstinline@IPAddress ip = WiFi.localIP();@\\
\lstinline@String ipString = String(ip[0]) + "." + ip[1] + "." + ip[2] + "." + ip[3];@

\subsection{UDP Between Boards}
Run the examples \lstinline@WiFiUdpSend@ and \lstinline@WiFiUdpReceiveSend@, one 
on each of 2 boards. Be sure to update \lstinline@remoteIp@ in the 
\lstinline@WiFiUdpSend@ sketch to be the IP address of the other board. Once 
running, the right button on the \lstinline@@ board should turn the LED on 
the other board on and off.

Modify this to do something else (buzzer, NeoPixels, motor, etc.). Demo for the 
instructor/TA.

\subsection{Bluetooth Low Energy}
Be sure to generate your own UUIDs for your particular project. If you use
the UUIDs from the examples, you will not be able to tell if you are connecting
to your board or someone else's who is using the same UUIDs. You can use the 
\href{https://www.uuidgenerator.net/}{UUID Generator} to create random UUIDs.
Be sure to set the device (\lstinline@BLE.setDeviceName@) and local names 
(\lstinline@BLE.setLocalName@) on all boards to something unique to 
your group so that you can find it when scanning.

\subsubsection{Peripheral Setup}
\begin{enumerate}
    \item Include Arduino's BLE library \\
        \lstinline@#include <ArduinoBLE.h>@ 
    \item Create a BLEService. This is container for characteristics. You can
            have multiple services and characteristics per service.\\
        \lstinline@BLEService ledService(String UUID);@
    \item Create a variable for each characteristic. Characteristics have properties. 
            The most used properties are:
        \begin{enumerate}
            \item BLERead - This allows a connected device to read the value of this variable
            \item BLEWrite - This allows a connected device to change the value of the variable
            \item BLENotify -  This allows a connected device to be notified if the value changes
        \end{enumerate}
        \lstinline@BLEByteCharacteristic LEDCharacteristic(String UUID, BLERead | BLEWrite);@ \\
        \lstinline@BLEByteCharacteristic buttonCharacteristic(String UUID, BLERead | BLENotify);@
    \item The next setup is done in the \lstinline@setup()@ function
    \item Start the BLE module \\
        \lstinline@BLE.begin()@ 
    \item Set the device name. This is the externally advertised name \\
        \lstinline@BLE.setDeviceName("BUTTON_LED");@ 
    \item Set the local name. This can be checked by a device once connected \\
        \lstinline@BLE.setLocalName("BUTTON_LED_MCNEILL");@ 
    \item Set the service as advertised \\
        \lstinline@BLE.setAdvertisedService(ledService);@
    \item Add the characteristics to the service \\
        \lstinline@ledService.addCharacteristic(LEDCharacteristic);@
    \item Add the service to the BLE object \\
        \lstinline@BLE.addService(ledService);@
    \item Set initial values for each characteristic \\
        \lstinline@LEDCharacteristic.writeValue(0);@
    \item Finish by starting your BLE advertising its existence \\
        \lstinline@BLE.advertise();@
    \item In the \lstinline@loop()@ my preferred method is to create central device
            and check to see if a device has connected. Once it has, update the 
            values of the output characteristics and check if the writeable 
            characteristics have been written to.
\end{enumerate}
\subsubsection{Central Setup}

\subsubsection{Phone to Robot Interface}
Use the example code (\lstinline@BLE_ButtonLED@) (being sure to change UUIDs, device name and local name)
to turn an LED on and off on the robot from your phone. Change the code to 
do something else (buzzer, NeoPixel, motor (carefully), servo) when you change 
the value via the Bluetooth interface. Also, show the button on the board changing
the value read on your phone using the Notify property.

% \subsubsection{Inter-Robot Interface}
% For this part of the lab you will need to work with another group. Using the example 
% of a peripheral and central, use one robot to control something on the other robot.

\subsection{Clock}
Using the example for setting the RTC for the SD card, write a 
program that gets the current time, then displays the time in the 
format HH:MM:SS and the date (on a different line) in the format 
YYYY-MM-DD on the display that updates each second.

\section{Shutdown}
Be sure to turn off the battery switch prior to putting the robot away.

\section{Turn In}
Turn in the following:
\begin{enumerate}
    \item Have either the TA or the instructor sign-off on your lab
    \item A PDF of your sketch.
    \item .ino versions of your sketch.
    \item Fill out the end of lab quiz prior to leaving. Note that it includes asking you 
            for the output of the \lstinline$getIDs$ sketch. 
\end{enumerate}

\section{Resources}%\label{sec:distmotorservoresources}
\begin{enumerate}
    \item \href{https://www.uuidgenerator.net/}{UUID Generator} 
    \item PCB Schematic and Layout - see 
            \href{https://github.com/semcneil/Fundamentals-of-Microcontrollers-Manual}{class manual} 
            in the Arduino Startup $\rightarrow$ Schematics and PCB section
\end{enumerate}

